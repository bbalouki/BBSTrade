<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>metatrader.trade &mdash; BBSTrader 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=8d563738"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            BBSTrader
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">bbstrader</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BBSTrader</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">metatrader.trade</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for metatrader.trade</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">MetaTrader5</span> <span class="k">as</span> <span class="nn">Mt5</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">from</span> <span class="nn">.risk</span> <span class="kn">import</span> <span class="n">RiskManagement</span>
<span class="kn">from</span> <span class="nn">.account</span> <span class="kn">import</span> <span class="n">INIT_MSG</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TimeFrame</span><span class="p">,</span> <span class="n">TradePosition</span><span class="p">,</span> <span class="n">TickInfo</span><span class="p">,</span>
    <span class="n">raise_mt5_error</span><span class="p">,</span> <span class="n">trade_retcode_message</span><span class="p">,</span> <span class="n">config_logger</span>
<span class="p">)</span>

<span class="c1"># Configure the logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">config_logger</span><span class="p">(</span><span class="s1">&#39;trade.log&#39;</span><span class="p">,</span> <span class="n">console_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="Trade">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade">[docs]</a>
<span class="k">class</span> <span class="nc">Trade</span><span class="p">(</span><span class="n">RiskManagement</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extends the `RiskManagement` class to include specific trading operations, </span>
<span class="sd">    incorporating risk management strategies directly into trade executions.</span>
<span class="sd">    It offers functionalities to execute trades while managing risks </span>
<span class="sd">    according to the inherited RiskManagement parameters and methods.</span>

<span class="sd">    Exemple:</span>
<span class="sd">        &gt;&gt;&gt; import time</span>
<span class="sd">        &gt;&gt;&gt; # Initialize the Trade class with parameters</span>
<span class="sd">        &gt;&gt;&gt; trade = Trade(</span>
<span class="sd">        ...     symbol=&quot;#AAPL&quot;,               # Symbol to trade</span>
<span class="sd">        ...     expert_name=&quot;MyExpertAdvisor&quot;,# Name of the expert advisor</span>
<span class="sd">        ...     expert_id=12345,              # Unique ID for the expert advisor</span>
<span class="sd">        ...     version=&quot;1.0&quot;,                # Version of the expert advisor</span>
<span class="sd">        ...     target=5.0,                   # Daily profit target in percentage</span>
<span class="sd">        ...     start_time=&quot;09:00&quot;,           # Start time for trading</span>
<span class="sd">        ...     finishing_time=&quot;17:00&quot;,       # Time to stop opening new positions</span>
<span class="sd">        ...     ending_time=&quot;17:30&quot;,          # Time to close any open positions</span>
<span class="sd">        ...     max_risk=2.0,                 # Maximum risk allowed on the account in percentage</span>
<span class="sd">        ...     daily_risk=1.0,               # Daily risk allowed in percentage</span>
<span class="sd">        ...     max_trades=5,                 # Maximum number of trades per session</span>
<span class="sd">        ...     rr=2.0,                       # Risk-reward ratio</span>
<span class="sd">        ...     account_leverage=True,        # Use account leverage in calculations</span>
<span class="sd">        ...     std_stop=True,                # Use standard deviation for stop loss calculation</span>
<span class="sd">        ...     sl=20,                        # Stop loss in points (optional)</span>
<span class="sd">        ...     tp=30,                        # Take profit in points (optional)</span>
<span class="sd">        ...     be=10                         # Break-even in points (optional)</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Example to open a buy position</span>
<span class="sd">        &gt;&gt;&gt; trade.open_buy_position(mm=True, comment=&quot;Opening Buy Position&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Example to open a sell position</span>
<span class="sd">        &gt;&gt;&gt; trade.open_sell_position(mm=True, comment=&quot;Opening Sell Position&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Check current open positions</span>
<span class="sd">        &gt;&gt;&gt; opened_positions = trade.get_opened_positions</span>
<span class="sd">        &gt;&gt;&gt; if opened_positions is not None:</span>
<span class="sd">        ...     print(f&quot;Current open positions: {opened_positions}&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Close all open positions at the end of the trading session</span>
<span class="sd">        &gt;&gt;&gt; if trade.days_end():</span>
<span class="sd">        ...    trade.close_all_positions(comment=&quot;Closing all positions at day&#39;s end&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Print trading session statistics</span>
<span class="sd">        &gt;&gt;&gt; trade.statistics(save=True, dir=&quot;my_trading_stats&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Sleep until the next trading session if needed (example usage)</span>
<span class="sd">        &gt;&gt;&gt; sleep_time = trade.sleep_time()</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Sleeping for {sleep_time} minutes until the next trading session.&quot;)</span>
<span class="sd">        &gt;&gt;&gt; time.sleep(sleep_time * 60)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span>
        <span class="n">expert_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;bbstrader&#39;</span><span class="p">,</span>
        <span class="n">expert_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9818</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">start_time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1:00&quot;</span><span class="p">,</span>
        <span class="n">finishing_time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;23:00&quot;</span><span class="p">,</span>
        <span class="n">ending_time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;23:30&quot;</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Trade class with the specified parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            symbol (str): The `symbol` that the expert advisor will trade.</span>
<span class="sd">            expert_name (str): The name of the `expert advisor`.</span>
<span class="sd">            expert_id (int): The `unique ID` used to identify the expert advisor </span>
<span class="sd">                or the strategy used on the symbol.</span>
<span class="sd">            version (str): The `version` of the expert advisor.</span>
<span class="sd">            target (float): `Trading period (day, week, month) profit target` in percentage</span>
<span class="sd">            start_time (str): The` hour and minutes` that the expert advisor is able to start to run.</span>
<span class="sd">            finishing_time (str): The time after which no new position can be opened.</span>
<span class="sd">            ending_time (str): The time after which any open position will be closed.</span>
<span class="sd">            verbose (bool | None): If set to None (default), account summary and risk managment</span>
<span class="sd">                parameters are printed in the terminal.</span>

<span class="sd">        Inherits:</span>
<span class="sd">            -   max_risk </span>
<span class="sd">            -   max_trades</span>
<span class="sd">            -   rr</span>
<span class="sd">            -   daily_risk</span>
<span class="sd">            -   time_frame</span>
<span class="sd">            -   account_leverage</span>
<span class="sd">            -   std_stop</span>
<span class="sd">            -   pchange_sl</span>
<span class="sd">            -   sl</span>
<span class="sd">            -   tp</span>
<span class="sd">            -   be</span>
<span class="sd">        See the RiskManagement class for more details on these parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Call the parent class constructor first</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
            <span class="n">finishing_time</span><span class="o">=</span><span class="n">finishing_time</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>  <span class="c1"># Pass kwargs to the parent constructor</span>
        <span class="p">)</span>

        <span class="c1"># Initialize Trade-specific attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span> <span class="o">=</span> <span class="n">expert_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span> <span class="o">=</span> <span class="n">expert_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">ending_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finishing</span> <span class="o">=</span> <span class="n">finishing_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_frame&quot;</span><span class="p">,</span> <span class="s1">&#39;D1&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lot</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stop_loss</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">take_profit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_take_profit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">break_even_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_break_even</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deviation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deviation</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_time_hour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time_minutes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finishing_time_hour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finishing_time_minutes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finishing</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
            <span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ending_time_hour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ending_time_minutes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">buy_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sell_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opened_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opened_orders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_symbol</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_symbol</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">risk_managment</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; Everything is OK, @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="s2"> is Running ....&gt;&gt;&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Trade.initialize">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.initialize">[docs]</a>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the MetaTrader 5 (MT5) terminal for trading operations. </span>
<span class="sd">        This method attempts to establish a connection with the MT5 terminal. </span>
<span class="sd">        If the initial connection attempt fails due to a timeout, it retries after a specified delay. </span>
<span class="sd">        Successful initialization is crucial for the execution of trading operations.</span>

<span class="sd">        Raises:</span>
<span class="sd">            MT5TerminalError: If initialization fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Initializing the basics.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">initialize</span><span class="p">():</span>
                <span class="n">raise_mt5_error</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">INIT_MSG</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;You are running the @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="s2"> Expert advisor,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; Version @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">, on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;During initialization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.select_symbol">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.select_symbol">[docs]</a>
    <span class="k">def</span> <span class="nf">select_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Selects the trading symbol in the MetaTrader 5 (MT5) terminal. </span>
<span class="sd">        This method ensures that the specified trading </span>
<span class="sd">        symbol is selected and visible in the MT5 terminal, </span>
<span class="sd">        allowing subsequent trading operations such as opening and </span>
<span class="sd">        closing positions on this symbol.</span>

<span class="sd">        Raises:</span>
<span class="sd">            MT5TerminalError: If symbole selection fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">symbol_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">raise_mt5_error</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">INIT_MSG</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selecting symbol &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.prepare_symbol">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.prepare_symbol">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the selected symbol for trading. </span>
<span class="sd">        This method checks if the symbol is available and visible in the </span>
<span class="sd">        MT5 terminal. If the symbol is not visible, it attempts to select the symbol again. </span>
<span class="sd">        This step ensures that trading operations can be performed on the selected symbol without issues.</span>

<span class="sd">        Raises:</span>
<span class="sd">            MT5TerminalError: If the symbol cannot be made visible for trading operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">symbol_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">symbol_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">raise_mt5_error</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">INIT_MSG</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">symbol_info</span><span class="o">.</span><span class="n">visible</span><span class="p">:</span>
                <span class="n">raise_mt5_error</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">INIT_MSG</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initialization successfully completed.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing symbol &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.summary">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.summary">[docs]</a>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show a brief description about the trading program&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;╔═════════════════ Summary  ════════════════════╗</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Expert Advisor Name             @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Expert Advisor Version          @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Expert | Strategy ID            </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Trading Symbol                  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Trading Time Frame              </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tf</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Start Trading Time              </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time_hour</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time_minutes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Finishing Trading Time          </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">finishing_time_hour</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">finishing_time_minutes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Closing Position After          </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ending_time_hour</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ending_time_minutes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;╚═══════════════════════════════════════════════╝</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Trade.risk_managment">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.risk_managment">[docs]</a>
    <span class="k">def</span> <span class="nf">risk_managment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show the risk management parameters&quot;&quot;&quot;</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_risk</span><span class="p">()[</span><span class="s2">&quot;trade_loss&quot;</span><span class="p">]</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_risk</span><span class="p">()[</span><span class="s2">&quot;trade_profit&quot;</span><span class="p">]</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_risk_ok</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;Not OK&quot;</span>
        <span class="n">account_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span>
        <span class="n">_profit</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;total_profit&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="n">account_info</span><span class="o">.</span><span class="n">currency</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_currency_rates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">marging_currency</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;╔═════════════════  Risk Management ═════════════════════╗</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Account Name                     </span><span class="si">{</span><span class="n">account_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Account Number                   </span><span class="si">{</span><span class="n">account_info</span><span class="o">.</span><span class="n">login</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Account Server                   </span><span class="si">{</span><span class="n">account_info</span><span class="o">.</span><span class="n">server</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Account Balance                  </span><span class="si">{</span><span class="n">account_info</span><span class="o">.</span><span class="n">balance</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Account Profit                   </span><span class="si">{</span><span class="n">_profit</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Account Equity                   </span><span class="si">{</span><span class="n">account_info</span><span class="o">.</span><span class="n">equity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Account Leverage                 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_leverage</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Account Margin                   </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">account_info</span><span class="o">.</span><span class="n">margin</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Account Free Margin              </span><span class="si">{</span><span class="n">account_info</span><span class="o">.</span><span class="n">margin_free</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Maximum Drawdown                 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_risk</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Risk Allowed                     </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_risk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">risk_level</span><span class="p">()),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Volume                           </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">marging_currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Risk Per trade                   </span><span class="si">{</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">get_currency_risk</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Profit Expected Per trade        </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_profit</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Lot Size                         </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lot</span><span class="si">}</span><span class="s2"> Lots</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Stop Loss                        </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_loss</span><span class="si">}</span><span class="s2"> Points</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Loss Value Per Tick              </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Take Profit                      </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">take_profit</span><span class="si">}</span><span class="s2"> Points</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Profit Value Per Tick            </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">profit</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Break Even                       </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">break_even_points</span><span class="si">}</span><span class="s2"> Points</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Deviation                        </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">deviation</span><span class="si">}</span><span class="s2"> Points</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Trading Time Interval            </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_minutes</span><span class="p">()</span><span class="si">}</span><span class="s2"> Minutes</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Risk Level                       </span><span class="si">{</span><span class="n">ok</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Maximum Trades                   </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_trade</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;╚══════════════════════════════════════════════════════╝</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Trade.statistics">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.statistics">[docs]</a>
    <span class="k">def</span> <span class="nf">statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;stats&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print some statistics for the trading session and save to CSV if specified.</span>

<span class="sd">        Args:</span>
<span class="sd">            save (bool, optional): Whether to save the statistics to a CSV file.</span>
<span class="sd">            dir (str, optional): The directory to save the CSV file. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats</span><span class="p">,</span> <span class="n">additional_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>

        <span class="n">deals</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;deals&quot;</span><span class="p">]</span>
        <span class="n">wins</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;win_trades&quot;</span><span class="p">]</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;loss_trades&quot;</span><span class="p">]</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;profit&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;win_rate&quot;</span><span class="p">]</span>
        <span class="n">total_fees</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_fees&quot;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">average_fee</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;average_fee&quot;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">profitability</span> <span class="o">=</span> <span class="n">additional_stats</span><span class="p">[</span><span class="s2">&quot;profitability&quot;</span><span class="p">]</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">currency</span>
        <span class="n">net_profit</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">profit</span> <span class="o">+</span> <span class="n">total_fees</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">trade_risk</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_currency_risk</span><span class="p">()</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">expected_profit</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">trade_risk</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Formatting the statistics output</span>
        <span class="n">stats_output</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;╔═══════════════ Session Statistics ═════════════╗</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Total Trades                    </span><span class="si">{</span><span class="n">deals</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Winning Trades                  </span><span class="si">{</span><span class="n">wins</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Losing Trades                   </span><span class="si">{</span><span class="n">losses</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Session Profit                  </span><span class="si">{</span><span class="n">profit</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Total Fees                      </span><span class="si">{</span><span class="n">total_fees</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Average Fees                    </span><span class="si">{</span><span class="n">average_fee</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Net Profit                      </span><span class="si">{</span><span class="n">net_profit</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Risk per Trade                  </span><span class="si">{</span><span class="n">trade_risk</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Expected Profit per Trade       </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_profit</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Risk Reward Ratio               </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rr</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Win Rate                        </span><span class="si">{</span><span class="n">win_rate</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Sharpe Ratio                    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sharpe</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;║ Trade Profitability             </span><span class="si">{</span><span class="n">profitability</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;╚═════════════════════════════════════════════════╝</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Print the formatted statistics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">stats_output</span><span class="p">)</span>

        <span class="c1"># Save to CSV if specified</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">today_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Create a dictionary with the statistics</span>
            <span class="n">statistics_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Total Trades&quot;</span><span class="p">:</span> <span class="n">deals</span><span class="p">,</span>
                <span class="s2">&quot;Winning Trades&quot;</span><span class="p">:</span> <span class="n">wins</span><span class="p">,</span>
                <span class="s2">&quot;Losing Trades&quot;</span><span class="p">:</span> <span class="n">losses</span><span class="p">,</span>
                <span class="s2">&quot;Session Profit&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">profit</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Total Fees&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_fees</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Average Fees&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">average_fee</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Net Profit&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">net_profit</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Risk per Trade&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">trade_risk</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Expected Profit per Trade&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expected_profit</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Risk Reward Ratio&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span><span class="p">,</span>
                <span class="s2">&quot;Win Rate&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">win_rate</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Sharpe Ratio&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharpe</span><span class="p">(),</span>
                <span class="s2">&quot;Trade Profitability&quot;</span><span class="p">:</span> <span class="n">profitability</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># Create the directory if it doesn&#39;t exist</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">today_date</span><span class="si">}</span><span class="s2">_session.csv&quot;</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="c1"># Updated code to write to CSV</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span>
                    <span class="n">csv_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_MINIMAL</span>
                <span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">&quot;Statistic&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">stat</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">statistics_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">stat</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session statistics saved to </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.open_buy_position">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.open_buy_position">[docs]</a>
    <span class="k">def</span> <span class="nf">open_buy_position</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;BMKT&#39;</span><span class="p">,</span> <span class="s1">&#39;BLMT&#39;</span><span class="p">,</span> <span class="s1">&#39;BSTP&#39;</span><span class="p">,</span> <span class="s1">&#39;BSTPLMT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BMKT&#39;</span><span class="p">,</span>
        <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a Buy positin</span>

<span class="sd">        Args:</span>
<span class="sd">            action (str): `&#39;BMKT&#39;` for Market orders or `&#39;BLMT&#39;, </span>
<span class="sd">                &#39;BSTP&#39;,&#39;BSTPLMT&#39;` for pending orders</span>
<span class="sd">            price (float): The price at which to open an order</span>
<span class="sd">            id (int): The strategy id or expert Id</span>
<span class="sd">            mm (bool): Weither to put stop loss and tp or not</span>
<span class="sd">            comment (str): The comment for the opening position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span>
        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">point</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="s1">&#39;BMKT&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
                <span class="s2">&quot;You need to set a price for pending orders&quot;</span>
            <span class="n">_price</span> <span class="o">=</span> <span class="n">price</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tick_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">ask</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">digits</span>

        <span class="n">lot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lot</span><span class="p">()</span>
        <span class="n">stop_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stop_loss</span><span class="p">()</span>
        <span class="n">take_profit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_take_profit</span><span class="p">()</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deviation</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_DEAL</span><span class="p">,</span>
            <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">lot</span><span class="p">),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">_price</span><span class="p">,</span>
            <span class="s2">&quot;deviation&quot;</span><span class="p">:</span> <span class="n">deviation</span><span class="p">,</span>
            <span class="s2">&quot;magic&quot;</span><span class="p">:</span> <span class="n">Id</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">comment</span><span class="p">,</span>
            <span class="s2">&quot;type_time&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TIME_GTC</span><span class="p">,</span>
            <span class="s2">&quot;type_filling&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_FILLING_FOK</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">mm</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;sl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_price</span> <span class="o">-</span> <span class="n">stop_loss</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;tp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_price</span> <span class="o">+</span> <span class="n">take_profit</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="s1">&#39;BMKT&#39;</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_PENDING</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">()[</span><span class="n">action</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">break_even</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">comment</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request_result</span><span class="p">(</span><span class="n">_price</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">action</span><span class="p">),</span></div>


    <span class="k">def</span> <span class="nf">_order_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;BMKT&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">),</span>
            <span class="s1">&#39;SMKT&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY</span><span class="p">,</span> <span class="s1">&#39;SELL&#39;</span><span class="p">),</span>
            <span class="s1">&#39;BLMT&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY_LIMIT</span><span class="p">,</span> <span class="s1">&#39;BUY_LIMIT&#39;</span><span class="p">),</span>
            <span class="s1">&#39;SLMT&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL_LIMIT</span><span class="p">,</span> <span class="s1">&#39;SELL_LIMIT&#39;</span><span class="p">),</span>
            <span class="s1">&#39;BSTP&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY_STOP</span><span class="p">,</span> <span class="s1">&#39;BUY_STOP&#39;</span><span class="p">),</span>
            <span class="s1">&#39;SSTP&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL_STOP</span><span class="p">,</span> <span class="s1">&#39;SELL_STOP&#39;</span><span class="p">),</span>
            <span class="s1">&#39;BSTPLMT&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY_STOP_LIMIT</span><span class="p">,</span> <span class="s1">&#39;BUY_STOP_LIMIT&#39;</span><span class="p">),</span>
            <span class="s1">&#39;SSTPLMT&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL_STOP_LIMIT</span><span class="p">,</span> <span class="s1">&#39;SELL_STOP_LIMIT&#39;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">type</span>

<div class="viewcode-block" id="Trade.open_sell_position">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.open_sell_position">[docs]</a>
    <span class="k">def</span> <span class="nf">open_sell_position</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;SMKT&#39;</span><span class="p">,</span> <span class="s1">&#39;SLMT&#39;</span><span class="p">,</span> <span class="s1">&#39;SSTP&#39;</span><span class="p">,</span> <span class="s1">&#39;SSTPLMT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SMKT&#39;</span><span class="p">,</span>
        <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a sell positin</span>

<span class="sd">        Args:</span>
<span class="sd">            action (str): `&#39;SMKT&#39;` for Market orders</span>
<span class="sd">                or `&#39;SLMT&#39;, &#39;SSTP&#39;,&#39;SSTPLMT&#39;` for pending orders</span>
<span class="sd">            price (float): The price at which to open an order</span>
<span class="sd">            id (int): The strategy id or expert Id</span>
<span class="sd">            mm (bool): Weither to put stop loss and tp or not</span>
<span class="sd">            comment (str): The comment for the closing position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span>
        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">point</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="s1">&#39;SMKT&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
                <span class="s2">&quot;You need to set a price for pending orders&quot;</span>
            <span class="n">_price</span> <span class="o">=</span> <span class="n">price</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tick_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">bid</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">digits</span>

        <span class="n">lot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lot</span><span class="p">()</span>
        <span class="n">stop_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stop_loss</span><span class="p">()</span>
        <span class="n">take_profit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_take_profit</span><span class="p">()</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deviation</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_DEAL</span><span class="p">,</span>
            <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">lot</span><span class="p">),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">_price</span><span class="p">,</span>
            <span class="s2">&quot;deviation&quot;</span><span class="p">:</span> <span class="n">deviation</span><span class="p">,</span>
            <span class="s2">&quot;magic&quot;</span><span class="p">:</span> <span class="n">Id</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">comment</span><span class="p">,</span>
            <span class="s2">&quot;type_time&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TIME_GTC</span><span class="p">,</span>
            <span class="s2">&quot;type_filling&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_FILLING_FOK</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">mm</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;sl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_price</span> <span class="o">+</span> <span class="n">stop_loss</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;tp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_price</span> <span class="o">-</span> <span class="n">take_profit</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="s1">&#39;SMKT&#39;</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_PENDING</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">()[</span><span class="n">action</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">break_even</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">comment</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request_result</span><span class="p">(</span><span class="n">_price</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_risk_free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">max_trade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_trade</span><span class="p">()</span>
        <span class="n">loss_trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;loss_trades&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">loss_trades</span> <span class="o">&gt;=</span> <span class="n">max_trade</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Trade.check">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.check">[docs]</a>
    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify if all conditions for taking a position are valide,</span>
<span class="sd">        These conditions are based on the Maximum risk ,daily risk,</span>
<span class="sd">        the starting, the finishing, and ending trading time.</span>

<span class="sd">        Args:</span>
<span class="sd">            comment (str): The comment for the closing position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_end</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trading_time</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not Trading time, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_risk_ok</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Risk not allowed, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_risk_free</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum trades Reached, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">profit_target</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Profit target Reached !!! SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_profit</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_open_positions</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_positions</span><span class="p">(</span><span class="n">position_type</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="Trade.request_result">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.request_result">[docs]</a>
    <span class="k">def</span> <span class="nf">request_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;BMKT&#39;</span><span class="p">,</span> <span class="s1">&#39;BLMT&#39;</span><span class="p">,</span> <span class="s1">&#39;BSTP&#39;</span><span class="p">,</span> <span class="s1">&#39;BSTPLMT&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;SMKT&#39;</span><span class="p">,</span> <span class="s1">&#39;SLMT&#39;</span><span class="p">,</span> <span class="s1">&#39;SSTP&#39;</span><span class="p">,</span> <span class="s1">&#39;SSTPLMT&#39;</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a trading order has been sent correctly</span>

<span class="sd">        Args:</span>
<span class="sd">            price (float): Price for opening the position</span>
<span class="sd">            request (Dict[str, Any]): A trade request to sent to Mt5.order_sent() </span>
<span class="sd">            all detail in request can be found here https://www.mql5.com/en/docs/python_metatrader5/mt5ordersend_py</span>
<span class="sd">            </span>
<span class="sd">            type (str): The type of the order </span>
<span class="sd">                `(BMKT, SMKT, BLMT, SLMT, BSTP, SSTP, BSTPLMT, SSTPLMT)` </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Send a trading request</span>
        <span class="c1"># Check the execution result</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">()[</span><span class="nb">type</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">addtionnal</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">check_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">trade_retcode_message</span><span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Trade Order Request, RETCODE=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_CONNECTION</span><span class="p">,</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_TIMEOUT</span><span class="p">]:</span>
                <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span> <span class="ow">and</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">check_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                        <span class="n">trade_retcode_message</span><span class="p">(</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Print the result</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trade Order </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">!=</span> <span class="s2">&quot;BMKT&quot;</span> <span class="ow">or</span> <span class="nb">type</span> <span class="o">!=</span> <span class="s2">&quot;SMKT&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opened_orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
            <span class="n">long_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;1. </span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2"> Order #</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">order</span><span class="si">}</span><span class="s2"> Sent, Symbol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">, Price: @</span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Lot(s): </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">volume</span><span class="si">}</span><span class="s2">, Sl: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_stop_loss</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Tp: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_take_profit</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">long_msg</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;BMKT&quot;</span> <span class="ow">or</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;SMKT&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opened_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
                <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">ticket</span> <span class="o">==</span> <span class="n">result</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">order_type</span> <span class="o">=</span> <span class="s2">&quot;BUY&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buy_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">order_type</span> <span class="o">=</span> <span class="s2">&quot;SELL&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sell_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">)</span>
                        <span class="n">profit</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
                        <span class="n">order_info</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;2. </span><span class="si">{</span><span class="n">order_type</span><span class="si">}</span><span class="s2"> Position Opened, Symbol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">, Price: @</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">price_open</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Sl: @</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">sl</span><span class="si">}</span><span class="s2"> Tp: @</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">order_info</span><span class="p">)</span>
                        <span class="n">pos_info</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;3. [OPEN POSITIONS ON </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span><span class="si">}</span><span class="s2">, ACCOUNT OPEN PnL = </span><span class="si">{</span><span class="n">profit</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pos_info</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.open_position">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.open_position">[docs]</a>
    <span class="k">def</span> <span class="nf">open_position</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
            <span class="s1">&#39;BMKT&#39;</span><span class="p">,</span> <span class="s1">&#39;BLMT&#39;</span><span class="p">,</span> <span class="s1">&#39;BSTP&#39;</span><span class="p">,</span> <span class="s1">&#39;BSTPLMT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SMKT&#39;</span><span class="p">,</span> <span class="s1">&#39;SLMT&#39;</span><span class="p">,</span> <span class="s1">&#39;SSTP&#39;</span><span class="p">,</span> <span class="s1">&#39;SSTPLMT&#39;</span><span class="p">],</span>
        <span class="n">buy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sell</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a buy or sell position.</span>

<span class="sd">        Args:</span>
<span class="sd">            action (str): (`&#39;BMKT&#39;`, `&#39;SMKT&#39;`) for Market orders</span>
<span class="sd">                or (`&#39;BLMT&#39;, &#39;SLMT&#39;, &#39;BSTP&#39;, &#39;SSTP&#39;, &#39;BSTPLMT&#39;, &#39;SSTPLMT&#39;`) for pending orders</span>
<span class="sd">            buy (bool): A boolean True or False</span>
<span class="sd">            sell (bool): A boolean True or False</span>
<span class="sd">            id (int): The strategy id or expert Id</span>
<span class="sd">            mm (bool): Weither to put stop loss and tp or not</span>
<span class="sd">            comment (str): The comment for the closing position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">buy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_buy_position</span><span class="p">(</span>
                <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">mm</span><span class="o">=</span><span class="n">mm</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sell</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_sell_position</span><span class="p">(</span>
                <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">mm</span><span class="o">=</span><span class="n">mm</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">get_opened_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return all opened order&#39;s tickets&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened_orders</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">opened_orders</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">get_opened_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all opened position&#39;s tickets&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened_positions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">opened_positions</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">get_buy_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all buy  opened position&#39;s tickets&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buy_positions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_positions</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">get_sell_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all sell  opened position&#39;s tickets&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sell_positions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell_positions</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">get_be_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return All positon&#39;s tickets </span>
<span class="sd">            for which a break even has been set&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Trade.get_filtered_tickets">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.get_filtered_tickets">[docs]</a>
    <span class="k">def</span> <span class="nf">get_filtered_tickets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">filter_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">th</span><span class="o">=</span><span class="kc">None</span>
                             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get tickets for positions or orders based on filters.</span>

<span class="sd">        Args:</span>
<span class="sd">            id (int): The strategy id or expert Id</span>
<span class="sd">            filter_type (str): Filter type (&#39;orders&#39;, &#39;positions&#39;, &#39;buys&#39;, &#39;sells&#39;, &#39;win_trades&#39;)</span>
<span class="sd">                - `orders` are current open orders</span>
<span class="sd">                - `positions` are all current open positions</span>
<span class="sd">                - `buys` and `sells` are current buy or sell open positions </span>
<span class="sd">                - `win_trades` are current open position that have a profit greater than a threshold</span>
<span class="sd">            th (bool): the minimum treshold for winning position</span>
<span class="sd">                (only relevant when filter_type is &#39;win_trades&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[int] | None: A list of filtered tickets </span>
<span class="sd">                or None if no tickets match the criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span>

        <span class="k">if</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;orders&#39;</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_orders</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>

        <span class="n">filtered_tickets</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">magic</span> <span class="o">==</span> <span class="n">Id</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;buys&#39;</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;sells&#39;</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;win_trades&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">win_trade</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="n">th</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">filtered_tickets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">ticket</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">filtered_tickets</span> <span class="k">if</span> <span class="n">filtered_tickets</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Trade.get_current_open_orders">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.get_current_open_orders">[docs]</a>
    <span class="k">def</span> <span class="nf">get_current_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s1">&#39;orders&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_open_positions">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.get_current_open_positions">[docs]</a>
    <span class="k">def</span> <span class="nf">get_current_open_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s1">&#39;positions&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_win_trades">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.get_current_win_trades">[docs]</a>
    <span class="k">def</span> <span class="nf">get_current_win_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s1">&#39;win_trades&#39;</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="n">th</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_buys">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.get_current_buys">[docs]</a>
    <span class="k">def</span> <span class="nf">get_current_buys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s1">&#39;buys&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_sells">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.get_current_sells">[docs]</a>
    <span class="k">def</span> <span class="nf">get_current_sells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s1">&#39;sells&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.positive_profit">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.positive_profit">[docs]</a>
    <span class="k">def</span> <span class="nf">positive_profit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">th</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check is the total profit on current open positions</span>
<span class="sd">        Is greater than a minimum profit express as percentage </span>
<span class="sd">        of the profit target.</span>

<span class="sd">        Args:</span>
<span class="sd">            th (float): The minimum profit target on current positions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_open_positions</span><span class="p">()</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">balance</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">balance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span>
                    <span class="n">ticket</span><span class="o">=</span><span class="n">position</span>
                <span class="p">)</span>
                <span class="n">profit</span> <span class="o">+=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">profit</span>
            <span class="n">fees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;average_fee&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">current_profit</span> <span class="o">=</span> <span class="n">profit</span> <span class="o">+</span> <span class="n">fees</span>
            <span class="n">th_profit</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span><span class="o">*</span><span class="n">th</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span> <span class="k">if</span> <span class="n">th</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">target</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_profit</span> <span class="o">&gt;</span> <span class="n">th_profit</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.break_even">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.break_even">[docs]</a>
    <span class="k">def</span> <span class="nf">break_even</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if it&#39;s time to put the break even,</span>
<span class="sd">        if so , it will sets the break even ,and if the break even was already set,</span>
<span class="sd">        it checks if the price has moved in favorable direction,</span>
<span class="sd">        if so , it set the new break even.</span>

<span class="sd">        Args:</span>
<span class="sd">            id (int): The strategy Id or Expert Id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">be</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_break_even</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">magic</span> <span class="o">==</span> <span class="n">Id</span><span class="p">:</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">trade_tick_size</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">trade_tick_value</span>
                    <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">point</span>
                    <span class="n">digits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">digits</span>
                    <span class="n">points</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">profit</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">value</span> <span class="o">/</span> <span class="n">position</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
                    <span class="n">break_even</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">points</span><span class="o">/</span><span class="n">point</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">be</span>
                    <span class="k">if</span> <span class="n">break_even</span><span class="p">:</span>
                        <span class="c1"># Check if break-even has already been set for this position</span>
                        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">ticket</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_break_even</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">be</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Check if the price has moved favorably</span>
                            <span class="n">new_be</span> <span class="o">=</span> <span class="n">be</span> <span class="o">*</span> <span class="mf">0.50</span>
                            <span class="n">favorable_move</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span>
                                    <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">price_current</span> <span class="o">-</span> <span class="n">position</span><span class="o">.</span><span class="n">sl</span><span class="p">)</span> <span class="o">/</span> <span class="n">point</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">new_be</span><span class="p">)</span>
                                <span class="ow">or</span>
                                <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span>
                                    <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">sl</span> <span class="o">-</span> <span class="n">position</span><span class="o">.</span><span class="n">price_current</span><span class="p">)</span> <span class="o">/</span> <span class="n">point</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">new_be</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">favorable_move</span><span class="p">:</span>
                                <span class="c1"># Calculate the new break-even level and price</span>
                                <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">new_level</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                                        <span class="n">position</span><span class="o">.</span><span class="n">sl</span> <span class="o">+</span> <span class="p">(</span><span class="n">new_be</span> <span class="o">*</span> <span class="n">point</span><span class="p">),</span> <span class="n">digits</span><span class="p">)</span>
                                    <span class="n">new_price</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                                        <span class="n">position</span><span class="o">.</span><span class="n">sl</span> <span class="o">+</span> <span class="p">((</span><span class="mf">0.25</span> <span class="o">*</span> <span class="n">be</span><span class="p">)</span> <span class="o">*</span> <span class="n">point</span><span class="p">),</span> <span class="n">digits</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">new_level</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                                        <span class="n">position</span><span class="o">.</span><span class="n">sl</span> <span class="o">-</span> <span class="p">(</span><span class="n">new_be</span> <span class="o">*</span> <span class="n">point</span><span class="p">),</span> <span class="n">digits</span><span class="p">)</span>
                                    <span class="n">new_price</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                                        <span class="n">position</span><span class="o">.</span><span class="n">sl</span> <span class="o">-</span> <span class="p">((</span><span class="mf">0.25</span> <span class="o">*</span> <span class="n">be</span><span class="p">)</span> <span class="o">*</span> <span class="n">point</span><span class="p">),</span> <span class="n">digits</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">set_break_even</span><span class="p">(</span>
                                    <span class="n">position</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">new_price</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">new_level</span>
                                <span class="p">)</span></div>


<div class="viewcode-block" id="Trade.set_break_even">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.set_break_even">[docs]</a>
    <span class="k">def</span> <span class="nf">set_break_even</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">position</span><span class="p">:</span> <span class="n">TradePosition</span><span class="p">,</span>
                       <span class="n">be</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                       <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the break-even level for a given trading position.</span>

<span class="sd">        Args:</span>
<span class="sd">            position (TradePosition):</span>
<span class="sd">                The trading position for which the break-even is to be set</span>
<span class="sd">                This is the value return by `mt5.positions_get()`</span>
<span class="sd">            be (int): The break-even level in points.</span>
<span class="sd">            level (float): The break-even level in price</span>
<span class="sd">                if set to None , it will be calated automaticaly.</span>
<span class="sd">            price (float): The break-even price</span>
<span class="sd">                if set to None , it will be calated automaticaly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">point</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">digits</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">spread</span>
        <span class="n">fees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;average_fee&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_risk</span><span class="p">()[</span><span class="s2">&quot;trade_profit&quot;</span><span class="p">]</span>
        <span class="n">fees_points</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">fees</span> <span class="o">/</span> <span class="n">risk</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1"># If Buy</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">position</span><span class="o">.</span><span class="n">price_current</span> <span class="o">&gt;</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span><span class="p">:</span>
            <span class="c1"># Calculate the break-even level and price</span>
            <span class="n">break_even_level</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span> <span class="o">+</span> <span class="p">(</span><span class="n">be</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
            <span class="n">break_even_price</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span> <span class="o">+</span> \
                <span class="p">((</span><span class="n">fees_points</span> <span class="o">+</span> <span class="n">spread</span><span class="p">)</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
            <span class="n">_price</span> <span class="o">=</span> <span class="n">break_even_price</span> <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">price</span>
            <span class="n">_level</span> <span class="o">=</span> <span class="n">break_even_level</span> <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">level</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tick_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">ask</span> <span class="o">&gt;</span> <span class="n">_level</span><span class="p">:</span>
                <span class="c1"># Set the stop loss to break even</span>
                <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_SLTP</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL_STOP</span><span class="p">,</span>
                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">,</span>
                    <span class="s2">&quot;sl&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">_price</span><span class="p">,</span> <span class="n">digits</span><span class="p">),</span>
                    <span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="n">position</span><span class="o">.</span><span class="n">tp</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_break_even_request</span><span class="p">(</span>
                    <span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">_price</span><span class="p">,</span> <span class="n">digits</span><span class="p">),</span> <span class="n">request</span><span class="p">)</span>
        <span class="c1"># If Sell</span>
        <span class="k">elif</span> <span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">position</span><span class="o">.</span><span class="n">price_current</span> <span class="o">&lt;</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span><span class="p">:</span>
            <span class="n">break_even_level</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span> <span class="o">-</span> <span class="p">(</span><span class="n">be</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
            <span class="n">break_even_price</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span> <span class="o">-</span> \
                <span class="p">((</span><span class="n">fees_points</span> <span class="o">+</span> <span class="n">spread</span><span class="p">)</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
            <span class="n">_price</span> <span class="o">=</span> <span class="n">break_even_price</span> <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">price</span>
            <span class="n">_level</span> <span class="o">=</span> <span class="n">break_even_level</span> <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">level</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tick_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">bid</span> <span class="o">&lt;</span> <span class="n">_level</span><span class="p">:</span>
                <span class="c1"># Set the stop loss to break even</span>
                <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_SLTP</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY_STOP</span><span class="p">,</span>
                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">,</span>
                    <span class="s2">&quot;sl&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">_price</span><span class="p">,</span> <span class="n">digits</span><span class="p">),</span>
                    <span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="n">position</span><span class="o">.</span><span class="n">tp</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_break_even_request</span><span class="p">(</span>
                    <span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">_price</span><span class="p">,</span> <span class="n">digits</span><span class="p">),</span> <span class="n">request</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_break_even_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiket</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a request to set the stop loss to break even for a given trading position.</span>

<span class="sd">        Args:</span>
<span class="sd">            tiket (int): The ticket number of the trading position.</span>
<span class="sd">            price (float): The price at which the stop loss is to be set.</span>
<span class="sd">            request (dict): The request to set the stop loss to break even.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">addtionnal</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">check_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">trade_retcode_message</span><span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Break-Even Order Request, Position: #</span><span class="si">{</span><span class="n">tiket</span><span class="si">}</span><span class="s2">, RETCODE=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span> <span class="ow">and</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_NO_CHANGES</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">check_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                        <span class="n">trade_retcode_message</span><span class="p">(</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Break-Even Order </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Stop loss set to Break-even, Position: #</span><span class="si">{</span><span class="n">tiket</span><span class="si">}</span><span class="s2">, Symbol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">, Price: @</span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tiket</span><span class="p">)</span>

<div class="viewcode-block" id="Trade.win_trade">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.win_trade">[docs]</a>
    <span class="k">def</span> <span class="nf">win_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">position</span><span class="p">:</span> <span class="n">TradePosition</span><span class="p">,</span>
                  <span class="n">th</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a positon is wining or looing</span>
<span class="sd">        wen it is closed before be level , tp or sl.</span>

<span class="sd">        Args:</span>
<span class="sd">            th (int): The minimum profit for a position in point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">trade_tick_size</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">trade_tick_value</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">profit</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">value</span> <span class="o">/</span> <span class="n">position</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>

        <span class="n">spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">spread</span>
        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">point</span>
        <span class="n">fees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;average_fee&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_risk</span><span class="p">()[</span><span class="s2">&quot;trade_profit&quot;</span><span class="p">]</span>
        <span class="n">min_be</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">fees</span> <span class="o">/</span> <span class="n">risk</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">be</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_break_even</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">th</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">win_be</span> <span class="o">=</span> <span class="n">th</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">win_be</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_be</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">be</span><span class="p">)))</span>
        <span class="n">win_trade</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">points</span><span class="o">/</span><span class="n">point</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">be</span>
        <span class="c1"># Check if the positon is in profit</span>
        <span class="k">if</span> <span class="n">win_trade</span><span class="p">:</span>
            <span class="c1"># Check if break-even has already been set for this position</span>
            <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">ticket</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.profit_target">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.profit_target">[docs]</a>
    <span class="k">def</span> <span class="nf">profit_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fee</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">swap</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">commission</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">balance</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">balance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened_positions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opened_positions</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="c1"># This return two TradeDeal Object,</span>
                <span class="c1"># The first one is the one the opening order</span>
                <span class="c1"># The second is the closing order</span>
                <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trades_history</span><span class="p">(</span>
                    <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">to_df</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">profit</span> <span class="o">+=</span> <span class="n">history</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">profit</span>
                    <span class="n">commission</span> <span class="o">+=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">commission</span>
                    <span class="n">swap</span> <span class="o">+=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">swap</span>
                    <span class="n">fee</span> <span class="o">+=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fee</span>
            <span class="n">current_profit</span> <span class="o">=</span> <span class="n">profit</span> <span class="o">+</span> <span class="n">commission</span> <span class="o">+</span> <span class="n">fee</span> <span class="o">+</span> <span class="n">swap</span>
            <span class="k">if</span> <span class="n">current_profit</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.close_position">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.close_position">[docs]</a>
    <span class="k">def</span> <span class="nf">close_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">ticket</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                       <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">pct</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                       <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close an open position by it ticket</span>

<span class="sd">        Args:</span>
<span class="sd">            ticket (int): Positon ticket to close (e.g TradePosition.ticket)</span>
<span class="sd">            id (int): The unique ID of the Expert or Strategy</span>
<span class="sd">            pct (float): Percentage of the position to close</span>
<span class="sd">            comment (str): Comment for the closing position</span>

<span class="sd">        Returns:</span>
<span class="sd">        -   True if position closed, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get all Actives positions</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">buy_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tick_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">ask</span>
        <span class="n">sell_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tick_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">bid</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">digits</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deviation</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span> <span class="o">==</span> <span class="n">ticket</span>
                        <span class="ow">and</span> <span class="n">position</span><span class="o">.</span><span class="n">magic</span> <span class="o">==</span> <span class="n">Id</span>
                    <span class="p">):</span>
                    <span class="n">buy</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="n">sell</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_DEAL</span><span class="p">,</span>
                        <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                        <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">volume</span><span class="o">*</span><span class="n">pct</span><span class="p">),</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL</span> <span class="k">if</span> <span class="n">buy</span> <span class="k">else</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY</span><span class="p">,</span>
                        <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">ticket</span><span class="p">,</span>
                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">sell_price</span> <span class="k">if</span> <span class="n">buy</span> <span class="k">else</span> <span class="n">buy_price</span><span class="p">,</span>
                        <span class="s2">&quot;deviation&quot;</span><span class="p">:</span> <span class="n">deviation</span><span class="p">,</span>
                        <span class="s2">&quot;magic&quot;</span><span class="p">:</span> <span class="n">Id</span><span class="p">,</span>
                        <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">comment</span><span class="p">,</span>
                        <span class="s2">&quot;type_time&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TIME_GTC</span><span class="p">,</span>
                        <span class="s2">&quot;type_filling&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_FILLING_FOK</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">addtionnal</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">check_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                        <span class="n">trade_retcode_message</span><span class="p">(</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Closing Order Request, Position: #</span><span class="si">{</span><span class="n">ticket</span><span class="si">}</span><span class="s2">, RETCODE=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">while</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span> <span class="ow">and</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">check_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                                <span class="n">trade_retcode_message</span><span class="p">(</span>
                                    <span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Closing Order </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Position #</span><span class="si">{</span><span class="n">ticket</span><span class="si">}</span><span class="s2"> closed, Symbol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">, Price: @</span><span class="si">{</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.close_positions">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.close_positions">[docs]</a>
    <span class="k">def</span> <span class="nf">close_positions</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">position_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;buy&quot;</span><span class="p">,</span> <span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
            <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            position_type (str): Type of positions to close (&quot;all&quot;, &quot;buy&quot;, &quot;sell&quot;)</span>
<span class="sd">            id (int): The unique ID of the Expert or Strategy</span>
<span class="sd">            comment (str): Comment for the closing position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">position_type</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">position_type</span> <span class="o">==</span> <span class="s2">&quot;buy&quot;</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_buys</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">position_type</span> <span class="o">==</span> <span class="s2">&quot;sell&quot;</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_sells</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid position type: </span><span class="si">{</span><span class="n">position_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">position_type</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">pos_type</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">tickets</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span> <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tickets</span> <span class="o">=</span> <span class="n">positions</span>
                <span class="n">pos_type</span> <span class="o">=</span> <span class="n">position_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tickets</span> <span class="o">=</span> <span class="p">[]</span>
            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickets</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ticket</span> <span class="ow">in</span> <span class="n">tickets</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_position</span><span class="p">(</span><span class="n">ticket</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">):</span>
                    <span class="n">tickets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ticket</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ALL </span><span class="si">{</span><span class="n">position_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Positions closed, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tickets</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">position_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Positions not closed, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No </span><span class="si">{</span><span class="n">position_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Positions to close, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_stats">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.get_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get some stats about the trading day and trading history</span>

<span class="sd">        :return: tuple[Dict[str, Any]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get history of deals for one trading session</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">total_fees</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">loss_trades</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">win_trades</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">balance</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">balance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">deals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened_positions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">deals</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opened_positions</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trades_history</span><span class="p">(</span>
                    <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">to_df</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">profit</span>
                    <span class="n">comm</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">commission</span>
                    <span class="n">swap</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">swap</span>
                    <span class="n">fee</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fee</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">+</span> <span class="n">comm</span> <span class="o">+</span> <span class="n">swap</span> <span class="o">+</span> <span class="n">fee</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">loss_trades</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">win_trades</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">profit</span> <span class="o">+=</span> <span class="n">result</span>
                    <span class="n">total_fees</span> <span class="o">+=</span> <span class="p">(</span><span class="n">comm</span> <span class="o">+</span> <span class="n">swap</span> <span class="o">+</span> <span class="n">fee</span><span class="p">)</span>
            <span class="n">average_fee</span> <span class="o">=</span> <span class="n">total_fees</span> <span class="o">/</span> <span class="n">deals</span>
            <span class="n">win_rate</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">win_trades</span> <span class="o">/</span> <span class="n">deals</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">stats1</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;deals&quot;</span><span class="p">:</span> <span class="n">deals</span><span class="p">,</span>
                <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">profit</span><span class="p">,</span>
                <span class="s2">&quot;win_trades&quot;</span><span class="p">:</span> <span class="n">win_trades</span><span class="p">,</span>
                <span class="s2">&quot;loss_trades&quot;</span><span class="p">:</span> <span class="n">loss_trades</span><span class="p">,</span>
                <span class="s2">&quot;total_fees&quot;</span><span class="p">:</span> <span class="n">total_fees</span><span class="p">,</span>
                <span class="s2">&quot;average_fee&quot;</span><span class="p">:</span> <span class="n">average_fee</span><span class="p">,</span>
                <span class="s2">&quot;win_rate&quot;</span><span class="p">:</span> <span class="n">win_rate</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stats1</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;deals&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;win_trades&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;loss_trades&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;total_fees&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;average_fee&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;win_rate&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Get total stats</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trades_history</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">profit</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;profit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">commisions</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;commission&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">_fees</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">_swap</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;swap&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">total_profit</span> <span class="o">=</span> <span class="n">commisions</span> <span class="o">+</span> <span class="n">_fees</span> <span class="o">+</span> <span class="n">_swap</span> <span class="o">+</span> <span class="n">profit</span>
            <span class="n">account_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="n">account_info</span><span class="o">.</span><span class="n">balance</span>
            <span class="n">initial_balance</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="n">total_profit</span>
            <span class="n">profittable</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">balance</span> <span class="o">&gt;</span> <span class="n">initial_balance</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span>
            <span class="n">stats2</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;total_profit&quot;</span><span class="p">:</span> <span class="n">total_profit</span><span class="p">,</span>
                <span class="s2">&quot;profitability&quot;</span><span class="p">:</span> <span class="n">profittable</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stats2</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;total_profit&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;profitability&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">stats1</span><span class="p">,</span> <span class="n">stats2</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.sharpe">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.sharpe">[docs]</a>
    <span class="k">def</span> <span class="nf">sharpe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the Sharpe ratio of a returns stream</span>
<span class="sd">        based on a number of trading periods.</span>
<span class="sd">        The function assumes that the returns are the excess of</span>
<span class="sd">        those compared to a benchmark.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get total history</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trades_history</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">df2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;profit&quot;</span><span class="p">,</span> <span class="s2">&quot;commission&quot;</span><span class="p">,</span> <span class="s2">&quot;fee&quot;</span><span class="p">,</span> <span class="s2">&quot;swap&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">profit</span><span class="o">.</span><span class="n">values</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_trade</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="n">sharp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">sharp</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.days_end">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.days_end">[docs]</a>
    <span class="k">def</span> <span class="nf">days_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if it is the end of the trading day.&quot;&quot;&quot;</span>
        <span class="n">current_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span>
        <span class="n">current_minute</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span>

        <span class="n">ending_hour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ending_time_hour</span><span class="p">)</span>
        <span class="n">ending_minute</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ending_time_minutes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_hour</span> <span class="o">&gt;</span> <span class="n">ending_hour</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">current_hour</span> <span class="o">==</span> <span class="n">ending_hour</span> <span class="ow">and</span> <span class="n">current_minute</span> <span class="o">&gt;=</span> <span class="n">ending_minute</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.trading_time">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.trading_time">[docs]</a>
    <span class="k">def</span> <span class="nf">trading_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if it is time to trade.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time_hour</span><span class="p">)</span>
            <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span>
            <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finishing_time_hour</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time_hour</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time_minutes</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finishing_time_hour</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finishing_time_minutes</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.sleep_time">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.sleep_time">[docs]</a>
    <span class="k">def</span> <span class="nf">sleep_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weekend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">weekend</span><span class="p">:</span>
            <span class="c1"># claculate number of minute from the friday and to monday start</span>
            <span class="n">friday_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>
            <span class="n">monday_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>
            <span class="n">intra_day_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">monday_time</span> <span class="o">-</span> <span class="n">friday_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">60</span>
            <span class="n">inter_day_diff</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span>
            <span class="n">total_minutes</span> <span class="o">=</span> <span class="n">inter_day_diff</span> <span class="o">+</span> <span class="n">intra_day_diff</span>
            <span class="k">return</span> <span class="n">total_minutes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># claculate number of minute from the end to the start</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>
            <span class="n">minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">60</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span> <span class="o">-</span> <span class="n">minutes</span>
            <span class="k">return</span> <span class="n">sleep_time</span></div>


<div class="viewcode-block" id="Trade.get_current_time">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.Trade.get_current_time">[docs]</a>
    <span class="k">def</span> <span class="nf">get_current_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="create_trade_instance">
<a class="viewcode-back" href="../../metatrader.html#metatrader.trade.create_trade_instance">[docs]</a>
<span class="k">def</span> <span class="nf">create_trade_instance</span><span class="p">(</span>
        <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Trade</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates Trade instances for each symbol provided.</span>

<span class="sd">    Args:</span>
<span class="sd">        symbols: A list of trading symbols (e.g., [&#39;AAPL&#39;, &#39;MSFT&#39;]).</span>
<span class="sd">        params: A dictionary containing parameters for the Trade instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary where keys are symbols and values are corresponding Trade instances.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the &#39;symbols&#39; list is empty or the &#39;params&#39; dictionary is missing required keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instances</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">symbols</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;symbols&#39; list cannot be empty.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instances</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating Trade instance, SYMBOL=</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">instances</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Bertin Balouki SIMYELI.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>